<html lang="en">
    <!-- https://5balloons.info/post-form-data-to-api-using-axios-in-vuejs/ 
    https://5balloons.info/post-form-data-to-api-using-axios-in-vuejs/
    https://codepen.io/edvaldolima/pen/evzWor
    https://gist.github.com/richardblondet/ce87a397ef669d4d25dd21ea02b9dda1
    https://jsfiddle.net/ankurk91/w8y8k5wo/
    https://serversideup.net/uploading-files-vuejs-axios/
    -->
<head>
  <title>Form konversi prodi Informatika 2022</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
   <link href="https://cdn.jsdelivr.net/npm/vue-loading-overlay@3/dist/vue-loading.css" rel="stylesheet">
   <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>  
   <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
   <script src="https://cdn.jsdelivr.net/npm/vue-loading-overlay@3"></script>
   <!-- or point to a specific vue-select release -->
<script src="https://unpkg.com/vue-select@3.0.0"></script>
<link rel="stylesheet" href="https://unpkg.com/vue-select@3.0.0/dist/vue-select.css">
   <meta name="referrer" content="same-origin">
</head>
<body>
<div class="container">
        <p style="text-align: center;"><img src="https://drive.google.com/u/0/uc?id=19wQb9EOG5DIQJ3jTppyQf6NWoVTw-kVj&amp;export=download" alt="" width="750" /></p>
        <h1 style="text-align: center;">PENGAJUAN KLAIM KONVERSI SKS - MBKM</h1>
</div>
<main class="container" id="app">  
    <loading :active.sync="visible" :can-cancel="true"></loading>
    <input v-model="access_id" placeholder="Surat Tugas">
    <button v-on:click="onClickButtonCari">Cari</button>
    <br>
    <p style="white-space: pre-line;">{{ access_id_message }}</p>
  <p>
      <strong>IDENTITAS</strong><br>
      nama : {{profile.name}}<br>
      NIM : {{profile.nim}}<br>
      Kegiatan : {{profile.kegiatan}}

  </p>
  <div class="panel-group">
      <div class="panel panel-primary">
        <div class="panel-heading">STEP 1. PROFIL PESERTA</div>                 
        <div class="panel-body">  

            <form v-on:submit.prevent="submitEntry">
                <table>
                    <tbody>
                        <tr>
                            <td>
                                Nama 
                            </td>
                            <td>
                                <input v-model="entry_nama" placeholder="Nama lengkap">
                            </td>
                        </tr>
                        <tr>
                            <td>
                                NIM
                            </td>
                            <td>
                                <input v-model="entry_nim" placeholder="19.11.1155x">
                            </td>
                        </tr>
                        <tr>
                            <td>
                                No. Surat Tugas
                            </td>
                            <td>
                                <input v-model="entry_st" placeholder="contoh : 01/FIK/BANGKIT/2022">
                            </td>
                        </tr>
                        <tr>
                            <td>
                                Email
                            </td>
                            <td>
                                <input v-model="entry_email" placeholder="stefani@students.amikom.ac.id">
                            </td>
                        </tr>
                        <tr>
                            <td>
                                Kegiatan {{entry_kegiatan}}
                            </td>
                            <td>
                                <v-select 
                                :options="opsiKegiatan" 
                                label="title"
                                v-model="entry_kegiatan"
                              ></v-select>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="form-group">
                    <button class="btn btn-primary">Submit</button>
                </div>
            </form>
        </div>

      </div>

  </div>
  <div class="panel-group">
    <div class="panel panel-primary">
        <div class="panel-heading">STEP 2. UNGGAH BUKTI KEGIATAN</div>                 
        <div class="panel-body">  
            <div class="container">
                <label>File Sertifikat
                    <input type="file" @change="handleFileUploadSertifikat( $event )"/>
                </label>
                <button @click="submitFileSertifikat">Submit</button>
            </div>  
            <div class="container">
                <label>File Kontrak Konversi
                    <input type="file"  @change="handleFileUploadKontrak( $event )"/>
                </label>
                <button @click="submitFileKontrak" >Submit</button>
            </div>
            </div>
        </div>
    </div>
  </div>  
  <div class="panel-group">
    <div class="panel panel-primary">
     <div class="panel-heading">STEP 3. FORM KONVERSI</div>                  
        <div class="panel-body"> 
            <i class="fa fa-plus pull-right"  @click="addRow" style="font-size:25px;color:#337ab7;cursor:pointer"></i>
            
            <form v-on:submit.prevent="submitForm">
            <table class="table table-bordered">
            <thead class="text text-success">
                <tr>                            
                    <th>Objective</th>
                    <th>Durasi</th>
                    <th>Kode Matkul</th>
                    <th>Nama Matkul</th>
                    <th>SKS Matkul</th>
                    <th>Nilai Angka</th>
                    <th>Nilai Huruf</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for='(user, index) in items'>                            
                    <td>
                    <input  v-model="user.objective"  class="form-control" type="text" :disabled="user.status==='delete'" />
                    </td>
                    <td>
                    <input v-model="user.durasi" class="form-control" type="text" :disabled="user.status==='delete'" />
                    </td>
                    <td>
                    <input v-model="user.kode" class="form-control" type="text" :disabled="user.status==='delete'"/>
                    </td>
                    <td>
                    <input v-model="user.matkul" class="form-control" type="text" :disabled="user.status==='delete'"/>
                    </td>
                    <td>
                    <input v-model="user.sks" class="form-control" type="text" :disabled="user.status==='delete'"/>
                    </td>
                    <td>
                    <input v-model="user.angka" class="form-control" type="text" :disabled="user.status==='delete'"/>
                    </td>
                    <td>
                    <input v-model="user.huruf" class="form-control" type="text" :disabled="user.status==='delete'"/>
                    </td>
                    <td>
                    <i  @click="deleteRow(index)" class="fa fa-remove" style="font-size:25px;color:red;cursor:pointer"></i>
                    </td>
                </tr>                        
            </tbody>
            </table>
    
            <div class="form-group">
                <button class="btn btn-primary">Submit</button>
            </div>
            </form>
        </div> 
      </div>
    </div>
</main>
<script >
 Vue.use(VueLoading);
 Vue.component('v-select', VueSelect.VueSelect);
 var key="AKfycbxOohWGdEiZPjY-8EUUMIAwPZ9gIS_gPcETWu-OOKmBEalAnsLW1OYrRhB8f3IBeJ_6";
 var keyUpload="AKfycbyR7lNaFzjcE25mG7PIIhun0OayGp_LUnubYB3hsQbh5IOcaslR1oxJMrZdzy1XJo6BTg";
 var baseUrl=`https://script.google.com/macros/s/${key}/exec`;
 var baseUrlUpload=`https://script.google.com/macros/s/${keyUpload}/exec`;
 var app = new Vue({
     
   el: '#app',
   data: {
    opsiKegiatan:["Studi Independen","Magang Bersertifikat","Bangkit","Pertukaran Pelajar"],
    entry_kegiatan:"",entry_nama:"",entry_nim:"",entry_email:"",entry_st:"",
    fileUrlSertifikat:"",
    fileUrlKontrakKonversi:"",   
    fileSertifikat:"",  
    fileKontrak:"",
    visible:false,
    access_id:"",
    access_id_message:"001/FIK-IF/AMIKOM/REK.STUIND/07/2021",
    profile:{name:'waiting...',nim:'waiting..',kegiatan:'waiting..',email:'',no_surat:''},
    items:[{id:'',objective:'',durasi:'',kode:'',matkul:'',sks:'',angka:'',huruf:'',email:'',no_surat:'',status:''}]     
   },
    components: {
        Loading: VueLoading,
        
    },
   methods: {
    submitEntry,
    addRow: function() {   
       var randomId = Math.floor(100000 + Math.random() * 900000);
       this.items.push({id:randomId, objective:'',durasi:'',
                        kode:'',matkul:'',sks:'',
                        angka:'',huruf:'',email:app.profile.email,
                        no_surat:app.profile.no_surat,status:''});
        console.log("add "+this.items);
    },
    deleteRow(index){
        Swal.fire({
            title: 'Yakin dihapus?',
            text: "Proses tidak bisa diualng",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ya, hapus!'
            }).then((result) => {
            if (result.isConfirmed) {
                var item = this.items[index];
                item.status='delete'
                Vue.set(this.items,index,item)  

                Swal.fire(
                'Deleted!',
                'SKS Konversi berhasil dihapus.',
                'success'
                )
            }
            })   
        // var item = this.items[index];
        // item.status='delete'
        // Vue.set(this.items,index,item)        
    },
    submitForm,
    onClickButtonCari,
    submitFileKontrak,
    submitFileSertifikat,
    handleFileUploadSertifikat(event){
        this.fileSertifikat = event.target.files[0];
        // this.file = this.$refs.file.files[0];
      },
    handleFileUploadKontrak(event){
        this.fileKontrak = event.target.files[0];
      }
   }  
  })
  function submitEntry(){
      console.log("a");
      var dataTobeUpload ={
          nama:this.entry_nama,
          email:this.entry_email,
          nim:this.entry_nim,
          kegiatan:this.entry_kegiatan,
          no_surat:this.entry_st
      }
    var urlProfile = `${baseUrl}?action=8`;
                axios({
                    method: "post",
                    url: urlProfile,
                    data: dataTobeUpload,
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                                "Access-Control-Allow-Origin": "*"
                    })
                    .then(function (response) {
                        //handle success
                        console.log(response);
                    })
                    .catch(function (response) {
                        //handle error
                        console.log(response);
                    });

  }
  function onClickButtonCari(){
        let loader = this.$loading.show({
                loader: 'dots'
            });
            
        var urlProfile = baseUrl+"?action=1&sr="+app.access_id;
        var urlKonversi = baseUrl+"?action=2&sr="+app.access_id;
        let endpoints = [urlProfile,urlKonversi];
        console.log(endpoints);
        axios.all(endpoints.map((endpoint)=>axios.get(endpoint))).then(
            axios.spread((profile,konversi)=>{
                if(profile){
                    var _profil=profile.data.data.shift();
                    app.profile.name=_profil.nama;
                    app.profile.nim=_profil.nim;
                    app.profile.kegiatan=_profil.jenis_rekomendasi;
                    app.profile.email=_profil.email;
                    app.profile.no_surat=_profil.no_surat;
                }
                if(konversi){
                    var _items=konversi.data.data;
                    app.items=[];
                    _items.forEach(function(e,i){
                        app.items.push({id:e.id,objective:e.objective,durasi:e.durasi,
                                    kode:e.kode_makul, sks:e.sks, matkul:e.makul,
                                    angka:e.angka,huruf:e.huruf,email:e.email,
                                    no_surat:e.no_surat});
                    });
                }
                loader.hide();
            })
        ).catch(function (error) {
                // handle error
                console.log(error);
                loader.hide()
            })
        .then(function () {
        });
 }   
 function submitForm(){
        // var baseUrl = `https://script.google.com/macros/s/${app.key}/exec`

        // var urlKonversi = app.baseUrl+"?action=insert";
        var urlKonversi = baseUrl+"?action=6";
        var payload = {items:app.items,profile:app.profile};
        console.log("payload");
       
        
        Swal.fire({
            title: 'Data akan disimpan?',
            text: "Periksa dengan teliti",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ya, Submit'
            })
            .then((result) => {
            if (result.isConfirmed) {
                let loader = this.$loading.show({
                    loader: 'dots'
                });
                axios({
                    method: "post",
                    url: urlKonversi,
                    data: app.items,
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                                "Access-Control-Allow-Origin": "*"
                    })
                    .then(function (response) {
                        //handle success
                        console.log(response);
                        loader.hide();
                    })
                    .catch(function (response) {
                        //handle error
                        console.log(response);
                        loader.hide();
                    });

            }

            }) 

        
 }
 function submitFileSertifikat(){
    let loader = this.$loading.show({
                loader: 'dots'
            });
    const qs = new URLSearchParams({filename:this.fileSertifikat.name, mimeType: this.fileSertifikat.type, action:7});
    const fr = new FileReader();
    fr.readAsArrayBuffer(this.fileSertifikat);
    fr.onload = f => {
        axios({
                method: "post",
                url: `${baseUrl}?${qs}`,
                data: JSON.stringify([...new Int8Array(f.target.result)])
            }).then(function(r){
                app.fileUrlSertifikat = r.data.fileUrl;
                console.log(app.fileUrlSertifikat);
                loader.hide();
                Swal.fire(
                    'Good job!',
                    'Kamu berhasil mengunngah sertifikat',
                    'success'
                    )
                })
            .then(re=> loader.hide())
            .catch(error =>loader.hide());
        
    }
 }
 function submitFileKontrak(){
    let loader = this.$loading.show({
                loader: 'dots'
            });
    const qs = new URLSearchParams({filename:this.fileKontrak.name, mimeType: this.fileKontrak.type, action:7});
    const fr = new FileReader();
    fr.readAsArrayBuffer(this.fileKontrak);
    fr.onload = f => {
        axios({
                method: "post",
                url: `${baseUrl}?${qs}`,
                data: JSON.stringify([...new Int8Array(f.target.result)])
            }).then(function(r){
                app.fileKontrak = r.data.fileUrl;
                console.log(app.fileKontrak);
                loader.hide();
                Swal.fire(
                    'Good job!',
                    'Kamu berhasil mengunngah kontrak konversi',
                    'success'
                    )
                })
            .then(re=> loader.hide())
            .catch(error =>loader.hide());
        
    }
 }
 </script>
 </body>
 </html> 